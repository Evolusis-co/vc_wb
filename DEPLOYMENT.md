# Render Microservices Deployment Guide

Complete guide for deploying VoiceCoach and Web Chatbot as separate microservices on Render.

---

## ðŸŽ¯ Deployment Overview

This setup creates:
- âœ… **2 Web Services** (VoiceCoach API + Web Chatbot)
- âœ… **2 PostgreSQL Databases** (one per service)
- âœ… **Automatic HTTPS** (Render-provided SSL)
- âœ… **Health monitoring**
- âœ… **Auto-deploy on git push**

---

## ðŸš€ Quick Deploy (Using Blueprint)

### Step 1: Prepare Repository

1. Ensure all code is committed and pushed to GitHub
2. Verify `render.yaml` is in repository root

### Step 2: Connect to Render

1. Go to [Render Dashboard](https://dashboard.render.com/)
2. Click **"New"** â†’ **"Blueprint"**
3. Connect your GitHub repository
4. Render will detect `render.yaml`

### Step 3: Configure Secrets

Render will prompt for these environment variables:

**Required for Both Services:**
- `OPENAI_API_KEY` - Get from [OpenAI Platform](https://platform.openai.com/api-keys)

**VoiceCoach API Only:**
- `ELEVENLABS_API_KEY` - Get from [ElevenLabs](https://elevenlabs.io/) (optional)

**Web Chatbot Only:**
- `QDRANT_URL` - Get from [Qdrant Cloud](https://cloud.qdrant.io/)
- `QDRANT_API_KEY` - From Qdrant dashboard

**Auto-Generated (Don't Set Manually):**
- `SECRET_KEY` - Auto-generated by Render
- `FLASK_SECRET_KEY` - Auto-generated by Render
- `JWT_SECRET_KEY` - Auto-generated by Render
- `DATABASE_URL` - Auto-provided by PostgreSQL databases

### Step 4: Review and Deploy

1. Review the blueprint configuration
2. Click **"Apply"**
3. Wait 5-10 minutes for deployment

### Step 5: Verify Deployment

Check health endpoints:
```bash
# VoiceCoach API
curl https://voicecoach-api.onrender.com/health

# Web Chatbot
curl https://voicecoach-chatbot.onrender.com/health
```

Both should return status 200 with JSON response.

---

## ðŸ”§ Manual Deployment (Alternative Method)

If you prefer manual control or need to customize:

### 1. Create VoiceCoach API Service

1. **New Web Service:**
   - Name: `voicecoach-api`
   - Region: Oregon (or closest to you)
   - Branch: `main`
   - Root Directory: `voiceCoach-master`
   - Runtime: Python 3

2. **Build & Start:**
   - Build Command: `pip install -r requirements.txt`
   - Start Command: `uvicorn server:app --host 0.0.0.0 --port $PORT`

3. **Environment Variables:**
   ```
   PYTHON_VERSION=3.11.0
   ENVIRONMENT=production
   SECRET_KEY=[Generate in Render]
   OPENAI_API_KEY=[Your key]
   ELEVENLABS_API_KEY=[Your key]
   DATABASE_URL=[From database]
   ALLOWED_ORIGINS=https://voicecoach-chatbot.onrender.com
   ACCESS_TOKEN_EXPIRE_MINUTES=1440
   ENABLE_RABBITMQ=false
   ENABLE_VAD=true
   ENABLE_AUGMENTATION=true
   ```

4. **Health Check:**
   - Path: `/health`
   - Expected Status: 200

### 2. Create Web Chatbot Service

1. **New Web Service:**
   - Name: `voicecoach-chatbot`
   - Region: Oregon (same as API)
   - Branch: `main`
   - Root Directory: `voiceCoach-master/web_chatbot-main`
   - Runtime: Python 3

2. **Build & Start:**
   - Build Command: `pip install -r requirements.txt`
   - Start Command: `gunicorn -w 2 -b 0.0.0.0:$PORT --timeout 120 app:app`

3. **Environment Variables:**
   ```
   PYTHON_VERSION=3.11.0
   FLASK_ENV=production
   FLASK_SECRET_KEY=[Generate in Render]
   JWT_SECRET_KEY=[Generate in Render]
   OPENAI_API_KEY=[Your key]
   QDRANT_URL=[Your Qdrant URL]
   QDRANT_API_KEY=[Your Qdrant key]
   DATABASE_URL=[From database]
   CORS_ORIGINS=https://voicecoach-api.onrender.com
   AUTH_SERVICE_URL=https://voicecoach-api.onrender.com
   ```

4. **Health Check:**
   - Path: `/health`
   - Expected Status: 200

### 3. Create Databases

**VoiceCoach Database:**
1. New PostgreSQL Database
2. Name: `voicecoach-db`
3. Database Name: `voicecoach`
4. User: `voicecoach_user`
5. Region: Same as web service
6. Plan: Starter (or Free for testing)

**Chatbot Database:**
1. New PostgreSQL Database
2. Name: `chatbot-db`
3. Database Name: `chatbot`
4. User: `chatbot_user`
5. Region: Same as web service
6. Plan: Starter (or Free for testing)

### 4. Link Databases to Services

1. Go to each database
2. Copy the **Internal Database URL**
3. Add to respective service as `DATABASE_URL` environment variable

---

## âš ï¸ Common Issues & Solutions

### Issue 1: Database Connection Errors

**Error:** `could not connect to server`

**Solution:**
```bash
# Verify DATABASE_URL format in service environment
# Should be: postgresql://user:pass@host/db
# Render provides: postgres://user:pass@host/db
# Code auto-converts postgres:// to postgresql://
```

### Issue 2: Health Check Failing

**Error:** Service shows "Unhealthy" status

**Solutions:**
1. Check logs: `Logs` tab in service dashboard
2. Verify health endpoint: `curl https://your-service.onrender.com/health`
3. Check if service is binding to `0.0.0.0` not `localhost`
4. Ensure `PORT` environment variable is used

### Issue 3: CORS Errors

**Error:** `No 'Access-Control-Allow-Origin' header`

**Solution:**
```bash
# Update CORS environment variables with actual Render URLs
ALLOWED_ORIGINS=https://voicecoach-chatbot.onrender.com,https://your-frontend.onrender.com
CORS_ORIGINS=https://voicecoach-api.onrender.com,https://your-frontend.onrender.com
```

### Issue 4: Import Errors

**Error:** `ModuleNotFoundError: No module named 'X'`

**Solutions:**
1. Verify `requirements.txt` is in correct directory
2. Check `Root Directory` setting in service config
3. Rebuild service: `Manual Deploy` â†’ `Clear build cache & deploy`

### Issue 5: Slow Cold Starts

**Issue:** First request takes 30-60 seconds

**Solutions:**
1. Upgrade to Starter plan (keeps service warm)
2. Use external monitoring to ping service every 14 minutes
3. Accept as limitation of Free tier

### Issue 6: WebSocket Connection Issues

**Error:** WebSocket connections fail or timeout

**Solutions:**
1. Verify service is using WebSocket-compatible plan (Starter+)
2. Check browser console for CORS errors
3. Ensure token is valid: test `/auth/status` first
4. Use `wss://` (not `ws://`) for HTTPS deployments

---

## ðŸ” Security Checklist

Before going to production:

- [ ] All secrets configured as environment variables (not in code)
- [ ] `ENVIRONMENT=production` set
- [ ] `FLASK_DEBUG=False` set
- [ ] Strong, unique secrets generated for each service
- [ ] CORS origins restricted to actual domains
- [ ] Health checks configured and passing
- [ ] Database backups enabled
- [ ] SSL/HTTPS enabled (automatic on Render)
- [ ] Rate limiting configured (VoiceCoach has it built-in)
- [ ] API keys rotated from development
- [ ] Monitoring/alerting set up

---

## ðŸ“Š Monitoring & Logs

### View Logs

**Render Dashboard:**
1. Go to service
2. Click **"Logs"** tab
3. Filter by severity (Info, Warning, Error)

**Live Logs (Terminal):**
```bash
# Install Render CLI
npm install -g render-cli

# Login
render login

# Stream logs
render logs voicecoach-api --tail
render logs voicecoach-chatbot --tail
```

### Key Metrics to Monitor

**VoiceCoach API:**
- WebSocket connections: `Active connections` in logs
- Authentication success/failure rates
- OpenAI API response times
- Database connection pool status

**Web Chatbot:**
- Chat message response times
- Qdrant query latency
- JWT validation success rate
- Database query performance

---

## ðŸ”„ Deployment Updates

### Auto-Deploy on Git Push

Both services auto-deploy when you push to `main` branch.

**To enable:**
1. Go to service settings
2. Under **"Deploy"**
3. Enable **"Auto-Deploy"**

### Manual Deploy

**Via Dashboard:**
1. Go to service
2. Click **"Manual Deploy"**
3. Select **"Clear build cache & deploy"** if issues

**Via CLI:**
```bash
render deploy voicecoach-api
render deploy voicecoach-chatbot
```

### Rollback

**Via Dashboard:**
1. Go to service
2. Click **"Events"** tab
3. Find previous successful deploy
4. Click **"Rollback to this deploy"**

---

## ðŸ’° Cost Optimization

### Free Tier (Both Services Free)

**Limits:**
- Services sleep after 15 minutes of inactivity
- 750 hours/month free (combined across services)
- Cold start: 30-60 seconds on first request
- 512MB RAM per service

**Best for:**
- Development
- Testing
- Low-traffic demos

### Starter Plan ($7/month per service)

**Benefits:**
- Always-on (no cold starts)
- Better performance
- More RAM (512MB+)
- Priority support

**Cost:**
- VoiceCoach API: $7/month
- Web Chatbot: $7/month
- PostgreSQL (2 DBs): $7/month each
- **Total: ~$28/month**

**Best for:**
- Production with moderate traffic
- Business users
- Consistent uptime needed

### Database Options

**Free PostgreSQL:**
- 1GB storage
- Expires after 90 days
- Good for testing only

**Starter PostgreSQL ($7/month):**
- 10GB storage
- Daily backups
- High availability
- Good for production

**Professional ($30/month):**
- 50GB storage
- Point-in-time recovery
- For high-traffic apps

---

## ðŸ§ª Testing Deployment

### 1. Test Health Endpoints

```bash
curl https://voicecoach-api.onrender.com/health
curl https://voicecoach-chatbot.onrender.com/health
```

Expected: 200 OK with JSON

### 2. Test Authentication

**Signup (Chatbot):**
```bash
curl -X POST https://voicecoach-chatbot.onrender.com/auth/signup \
  -H "Content-Type: application/json" \
  -d '{
    "email":"test@example.com",
    "password":"TestPass123!",
    "name":"Test User"
  }'
```

**Login:**
```bash
curl -X POST https://voicecoach-chatbot.onrender.com/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email":"test@example.com",
    "password":"TestPass123!"
  }'
```

**Check Status:**
```bash
curl https://voicecoach-chatbot.onrender.com/auth/status \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 3. Test Chat

```bash
curl -X POST https://voicecoach-chatbot.onrender.com/api/chat \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "message":"I need help with workplace communication"
  }'
```

### 4. Test VoiceCoach WebSocket

Use browser console or WebSocket client:
```javascript
const ws = new WebSocket(
  'wss://voicecoach-api.onrender.com/ws/test-client?token=YOUR_TOKEN&personality=entj_commander&scenario=role_shift'
);

ws.onopen = () => console.log('Connected');
ws.onmessage = (e) => console.log('Received:', JSON.parse(e.data));
ws.onerror = (e) => console.error('Error:', e);
```

---

## ðŸ“ž Support

**Render Issues:**
- [Render Documentation](https://render.com/docs)
- [Render Community](https://community.render.com/)
- [Status Page](https://status.render.com/)

**Application Issues:**
1. Check service logs in Render dashboard
2. Verify environment variables
3. Test locally first
4. Check database connection

---

## âœ… Post-Deployment Checklist

After successful deployment:

- [ ] Both services showing "Live" status
- [ ] Health checks passing
- [ ] Database connections working
- [ ] Authentication flow tested
- [ ] CORS configured correctly
- [ ] Environment variables verified
- [ ] Monitoring set up
- [ ] Backup strategy in place
- [ ] Domain names configured (if custom)
- [ ] SSL certificates active
- [ ] Rate limiting verified
- [ ] Error tracking configured
- [ ] Performance baseline established
- [ ] Team has access to Render dashboard

---

**Deployment Date:** November 2025  
**Last Updated:** November 2025  
**Render Blueprint Version:** 1.0
